/* This file was generated by the Pallene compiler. Do not edit by hand" */
/* Indentation and formatting courtesy of pallene/C.lua */

#include "pallene_core.h"

/* ------- */
/* Records */
/* ------- */

/* ------------------- */
/* Function Prototypes */
/* ------------------- */

static void function_01(
    lua_State *L,
    Udata *G,
    StackValue *base
);
static lua_Integer function_02(
    lua_State *L,
    Udata *G,
    StackValue *base,
    Table *x1, /* t */
    lua_Integer x2  /* x */
);
static lua_Integer function_03(
    lua_State *L,
    Udata *G,
    StackValue *base,
    Table *x1, /* t */
    lua_Integer x2  /* nrep */
);

/* ------------------------ */
/* Function Implementations */
/* ------------------------ */

/* $init */
static void function_01(
    lua_State *L,
    Udata *G,
    StackValue *base
) {
    	
}

/* binsearch benchmarks/binsearch/pallene.pln:1 */
static lua_Integer function_02(
    lua_State *L,
    Udata *G,
    StackValue *base,
    Table *x1, /* t */
    lua_Integer x2  /* x */
) {
    lua_Integer x3; /* lo */
    lua_Integer x4; /* hi */
    lua_Integer x5; /* steps */
    lua_Integer x6; /* mid */
    lua_Integer x7; /* tmid */
    int x8;
    lua_Integer x9;
    lua_Integer x10;
    int x11;
    int x12;
    	
    x3 = 1;
    if (x1->metatable) {
        pallene_runtime_array_metatable_error(L, 4);
    }
    x4 = luaH_getn(x1);
    x5 = 0;
    while (1) {
        x8 = (x3 < x4);
        if (!x8) {
            break;
        }
        x10 = intop(-, x4, x3);
        x9 = pallene_int_divi(L, x10, 2, 10);
        x6 = intop(+, x3, x9);
        x5 = intop(+, x5, 1);
        {
            pallene_renormalize_array(L, x1, x6, 13);
            TValue *slot = &x1->array[x6 - 1];
            if (PALLENE_UNLIKELY(!ttisinteger(slot))) {
                pallene_runtime_tag_check_error(L,
                    13, LUA_TNUMINT, rawtt(slot),
                    "array element");
            }
            x7 = ivalue(slot);
        }
        x11 = (x2 == x7);
        if (x11) {
            return x5;
        } else {
            x12 = (x2 < x7);
            if (x12) {
                x4 = intop(-, x6, 1);
            } else {
                x3 = intop(+, x6, 1);
            }
        }
    }
    return x5;
}

/* test benchmarks/binsearch/pallene.pln:27 */
static lua_Integer function_03(
    lua_State *L,
    Udata *G,
    StackValue *base,
    Table *x1, /* t */
    lua_Integer x2  /* nrep */
) {
    lua_Integer x3; /* s */
    lua_Integer x4; /* i */
    int x5;
    lua_Integer x6;
    	
    x3 = 0;
    PALLENE_INT_FOR_LOOP_BEGIN(x4, 1, x2, 1)
    {
        {
            StackValue *old_stack = L->stack;
            x6 = function_02(L, G, base + 0, x1, x4);
            base = L->stack + (base - old_stack);
        }
        x5 = (x6 != 22);
        if (x5) {
            x3 = intop(+, x3, 1);
        }
    }
    PALLENE_INT_FOR_LOOP_END
    return x3;
}

/* ------- */
/* Exports */
/* ------- */

static int function_01_lua(lua_State *L)
{
    StackValue *base = L->ci->func;
    CClosure *func = clCvalue(s2v(base));
    Udata *G = uvalue(&func->upvalue[0]);
    	
    int nargs = lua_gettop(L);
    if (PALLENE_UNLIKELY(nargs != 0)) {
        pallene_runtime_arity_error(L, "$init", 0, nargs);
    }
    	
    function_01(L, G, L->top);
    return 0;
}

static int function_02_lua(lua_State *L)
{
    StackValue *base = L->ci->func;
    CClosure *func = clCvalue(s2v(base));
    Udata *G = uvalue(&func->upvalue[0]);
    	
    int nargs = lua_gettop(L);
    if (PALLENE_UNLIKELY(nargs != 2)) {
        pallene_runtime_arity_error(L, "binsearch", 2, nargs);
    }
    	
    Table *x1;
    lua_Integer x2;
    	
    if (PALLENE_UNLIKELY(!ttistable(s2v(base + 1)))) {
        pallene_runtime_tag_check_error(L,
            1, LUA_TTABLE, rawtt(s2v(base + 1)),
            "argument '%s'", "t");
    }
    x1 = hvalue(s2v(base + 1));
    	
    if (PALLENE_UNLIKELY(!ttisinteger(s2v(base + 2)))) {
        pallene_runtime_tag_check_error(L,
            1, LUA_TNUMINT, rawtt(s2v(base + 2)),
            "argument '%s'", "x");
    }
    x2 = ivalue(s2v(base + 2));
    	
    lua_Integer ret1;
    ret1 = function_02(L, G, L->top, x1, x2);
    setivalue(s2v(L->top), ret1);
    L->top++;
    return 1;
}

static int function_03_lua(lua_State *L)
{
    StackValue *base = L->ci->func;
    CClosure *func = clCvalue(s2v(base));
    Udata *G = uvalue(&func->upvalue[0]);
    	
    int nargs = lua_gettop(L);
    if (PALLENE_UNLIKELY(nargs != 2)) {
        pallene_runtime_arity_error(L, "test", 2, nargs);
    }
    	
    Table *x1;
    lua_Integer x2;
    	
    if (PALLENE_UNLIKELY(!ttistable(s2v(base + 1)))) {
        pallene_runtime_tag_check_error(L,
            27, LUA_TTABLE, rawtt(s2v(base + 1)),
            "argument '%s'", "t");
    }
    x1 = hvalue(s2v(base + 1));
    	
    if (PALLENE_UNLIKELY(!ttisinteger(s2v(base + 2)))) {
        pallene_runtime_tag_check_error(L,
            27, LUA_TNUMINT, rawtt(s2v(base + 2)),
            "argument '%s'", "nrep");
    }
    x2 = ivalue(s2v(base + 2));
    	
    lua_Integer ret1;
    ret1 = function_03(L, G, L->top, x1, x2);
    setivalue(s2v(L->top), ret1);
    L->top++;
    return 1;
}

int luaopen_benchmarks_binsearch_pallene(lua_State *L)
{
    luaL_checkversion(L);
    	
    lua_newuserdatauv(L, 0, 0);
    int globals = lua_gettop(L);
    	
    lua_createtable(L, 3, 0);
    int closures = lua_gettop(L);
    	
    lua_newtable(L);
    int export_table = lua_gettop(L);
    	
    /* Closures */
    	
    lua_pushvalue(L, globals);
    lua_pushcclosure(L, function_01_lua, 1);
    lua_seti(L, closures, 1);
    	
    lua_pushvalue(L, globals);
    lua_pushcclosure(L, function_02_lua, 1);
    lua_seti(L, closures, 2);
    	
    lua_pushvalue(L, globals);
    lua_pushcclosure(L, function_03_lua, 1);
    lua_seti(L, closures, 3);
    	
    /* Global values */
    	
    // Run toplevel statements & initialize globals
    lua_geti(L, closures, 1);
    lua_call(L, 0, 0);
    	
    /* Exports */
    	
    lua_pushstring(L, "binsearch");
    lua_geti(L, closures, 2);
    lua_settable(L, export_table);
    	
    lua_pushstring(L, "test");
    lua_geti(L, closures, 3);
    lua_settable(L, export_table);
    	
    lua_pushvalue(L, export_table);
    return 1;
}

